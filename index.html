<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ’éŠæœƒå…¨åŠŸèƒ½å°è¦½</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        /* --- 1. å…¨åŸŸè¨­å®š --- */
        :root {
            --primary: #FF8C00;
            --primary-light: #FFF5E6;
            --text-main: #333;
            --text-sub: #666;
            --bg: #F4F5F7;
            --white: #FFFFFF;
            --danger: #FF4757;
            --max-width: 480px; 
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, sans-serif;
            background-color: #333; 
            margin: 0; padding: 0;
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            display: flex; justify-content: center; min-height: 100vh;
        }

        /* --- 2. æ ¸å¿ƒå®¹å™¨ --- */
        #app-container {
            width: 100%; max-width: var(--max-width);
            background-color: var(--bg);
            min-height: 100vh; position: relative;
            padding-bottom: 80px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- 3. ç™»å…¥ç•«é¢ --- */
        #page-login {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #06C755, #21D4FD);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .login-box {
            background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px;
            width: 80%; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .login-input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; text-align: center; box-sizing: border-box;}
        .btn-main {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-line { background: #06C755; }

        /* --- 4. é ‚éƒ¨ Header --- */
        .header {
            position: sticky; top: 0; background: var(--white); z-index: 100;
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold;
        }
        .page { display: none; animation: fadeIn 0.3s; padding: 10px; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 5. å•†å“èˆ‡åˆ†é¡ --- */
        .cat-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; scrollbar-width: none; }
        .cat-btn { padding: 6px 14px; background: white; border: 1px solid #ddd; border-radius: 20px; white-space: nowrap; cursor: pointer; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .product-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .p-info { flex: 1; cursor: pointer; }
        .p-name { font-weight: bold; font-size: 1rem; margin-bottom: 4px; }
        .p-meta { font-size: 0.85rem; color: var(--text-sub); }
        .tag-sale { background: #FFEDD5; color: #C2410C; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        .btn-add { width: 35px; height: 35px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; margin-left: 10px; flex-shrink: 0; }

        /* --- 6. åœ°åœ–è¨­å®š (é‡è¦) --- */
        /* â˜… ä¿®æ”¹ï¼šè®“åœ°åœ–å€å¡Šè®Šæˆä¸€å€‹å›ºå®šé«˜åº¦çš„ã€Œè¦–çª—ã€ï¼Œä¸¦éš±è—è¶…å‡ºçš„éƒ¨åˆ† â˜… */
        .map-wrapper { 
            position: relative; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #E5E7EB; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            height: 55vh; /* è¨­å®šåœ°åœ–å€å¡Šé«˜åº¦ */
            display: flex; 
            align-items: center; 
            justify-content: center;
            touch-action: none; /* é˜²æ­¢æ»‘å‹•åœ°åœ–æ™‚è§¸ç™¼ç¶²é åŸç”Ÿæ²å‹• */
            cursor: grab;
        }
        .map-wrapper:active { cursor: grabbing; }
        
        /* â˜… æ–°å¢ï¼šå…§éƒ¨å¯¦éš›è¢«ç¸®æ”¾çš„å®¹å™¨ â˜… */
        #map-content {
            width: 100%;
            position: relative;
        }
        #map-content img { width: 100%; display: block; pointer-events: none; /* é¿å…åœ–ç‰‡æ‹–æ›³å¹²æ“¾ */ }
        
        /* ä¸€èˆ¬åœ°æ¨™è¨­å®š */
        .pin { 
            position: absolute; transform: translate(-50%, -50%); 
            padding: 4px 8px; border-radius: 12px; 
            font-size: 0.75rem; font-weight: bold; color: white; 
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            white-space: nowrap; z-index: 10; border: 2px solid white;
        }
        .pin:active { transform: translate(-50%, -50%) scale(0.9); }
        .pin.me { background: #2ecc71; color: white; z-index: 5; }
        .pin.stage { background: #3498db; z-index: 5; }
        
        /* æ™‚äº‹ç´…é»æ¨£å¼ */
        .pin.red-dot {
            width: 18px; height: 18px;
            background-color: var(--danger);
            border-radius: 50%;
            padding: 0;
            border: 2px solid white;
            color: transparent; 
            overflow: hidden;
            animation: radarPulse 1.5s infinite; 
            box-shadow: 0 0 0 rgba(255, 71, 87, 0.7);
            transition: all 0.3s ease;
        }
        
        @keyframes radarPulse {
            0% { transform: translate(-50%,-50%) scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: translate(-50%,-50%) scale(1); box-shadow: 0 0 0 12px rgba(255, 71, 87, 0); }
            100% { transform: translate(-50%,-50%) scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .pin.red-dot.dimmed {
            opacity: 0.15; 
            animation: none; 
            pointer-events: none; 
            border-color: rgba(255,255,255,0.3);
        }
        
        .pin.red-dot.ijen-active {
            background-color: #F59E0B; 
            animation: radarPulseIjen 1.2s infinite; 
        }
        
        @keyframes radarPulseIjen {
            0% { transform: translate(-50%,-50%) scale(0.95); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.8); }
            70% { transform: translate(-50%,-50%) scale(1.2); box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
            100% { transform: translate(-50%,-50%) scale(0.95); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        .map-actions { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }

        /* --- 7. è³¼ç‰©è»Šèˆ‡å…¶ä»– --- */
        .search-bar { width: 100%; padding: 12px; border: none; background: #E5E7EB; border-radius: 8px; font-size: 1rem; box-sizing: border-box; outline: none; }
        .keyword-box { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .keyword { background: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; color: #555; cursor: pointer; border: 1px solid #eee; }
        .checkout-box { background: white; padding: 20px; border-radius: 15px; margin-top: 20px; }
        .delivery-option { background: #F9FAFB; padding: 15px; border-radius: 8px; margin: 15px 0; display: flex; align-items: center; gap: 10px; cursor: pointer; }

        /* --- 8. åº•éƒ¨å°è¦½åˆ— --- */
        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; max-width: var(--max-width);
            background: white; border-top: 1px solid #eee; 
            display: flex; justify-content: space-around; 
            padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); 
            z-index: 900; box-sizing: border-box;
        }
        .nav-item { text-align: center; color: #999; font-size: 0.75rem; flex: 1; cursor: pointer; position: relative; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }
        .badge { background: var(--danger); color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7rem; position: absolute; top: -5px; left: 50%; margin-left: 5px; display: none; }

        /* --- 9. å½ˆå‡ºè¦–çª— --- */
        .modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; text-align: center; animation: popIn 0.3s; position: relative; }
        .close-btn { position: absolute; right: 15px; top: 15px; font-size: 1.5rem; line-height: 1; cursor: pointer; color: #999; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .chest-container { display: flex; justify-content: center; gap: 15px; margin-top: 20px; margin-bottom: 10px; }
        .chest { font-size: 3.5rem; cursor: pointer; transition: transform 0.2s; user-select: none; }
        .chest:active { transform: scale(0.9); }
        .chest.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .chest-label { font-size: 0.8rem; color: #888; margin-top: 5px; }

    </style>
</head>
<body> 

<div id="app-container">

    <div id="page-login">
        <div class="login-box">
            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ¡</div>
            <h2 style="margin: 0; color: #333;">åœ’éŠæœƒå°è¦½</h2>
            <p id="login-msg" style="color: #666; font-size: 0.9rem;">æ­£åœ¨é€£æ¥...</p>
            <div id="manual-login" style="display:none;">
                <input type="text" id="login-user" class="login-input" placeholder="è«‹è¼¸å…¥æš±ç¨±">
                <button class="btn-main" onclick="handleManualLogin()">é€²å…¥ç³»çµ±</button>
            </div>
            <button id="btn-line-login" class="btn-main btn-line" style="display:none; margin-top: 10px;" onclick="liff.login()">LINE ç™»å…¥</button>
        </div>
    </div>

    <header class="header" id="main-header" style="display:none;">
        <span id="header-title">æ‰€æœ‰æ”¤ä½</span>
        <div style="display:flex; align-items:center; gap:5px;">
            <img id="user-avatar" src="" style="width:24px; height:24px; border-radius:50%; display:none;">
            <span style="font-size: 0.9rem; color: var(--primary);" id="user-display">è¨ªå®¢</span>
        </div>
    </header>

    <div id="tab-classes" class="page">
        <div class="cat-scroll">
            <button class="cat-btn active" onclick="filterProducts('all', this)">å…¨éƒ¨</button>
            <button class="cat-btn" onclick="filterProducts('å•†ä¸‰ä¹™', this)">å•†ä¸‰ä¹™</button>
            <button class="cat-btn" onclick="filterProducts('æœä¸‰ä¹™', this)">æœä¸‰ä¹™</button>
            <button class="cat-btn" onclick="filterProducts('å®¶äºŒä¹™', this)">å®¶äºŒä¹™</button>
            <button class="cat-btn" onclick="filterProducts('æœäºŒç”²', this)">æœäºŒç”²</button>
        </div>
        <div id="product-list" style="margin-top: 15px;"></div>
    </div>

    <div id="tab-map" class="page">
        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px;">
            <button class="cat-btn" id="btn-zoom-in" style="font-size: 0.8rem; padding: 4px 10px;">â• æ”¾å¤§</button>
            <button class="cat-btn" id="btn-zoom-out" style="font-size: 0.8rem; padding: 4px 10px;">â– ç¸®å°</button>
            <button class="cat-btn" id="btn-zoom-reset" style="font-size: 0.8rem; padding: 4px 10px;">ğŸ”„ æ­¸ä½</button>
        </div>

        <div class="map-wrapper" id="map-viewport">
            <div id="map-content">
                <img src="map.jpg" alt="åœ’éŠæœƒåœ°åœ–" onerror="this.src='https://via.placeholder.com/800x600?text=Please+Upload+map.jpg'">
                
                <div class="pin stage" style="top: 12%; left: 35%;" onclick="showInfo('å¸ä»¤å°', 'æ´»å‹•è¡¨æ¼”å€')">å¸ä»¤å°</div>
                <div class="pin red-dot" id="pin-3y" style="top: 85%; left: 41%;" onclick="showClassInfo('å•†ä¸‰ä¹™')">å•†ä¸‰ä¹™</div>
                <div class="pin red-dot" id="pin-f3" style="top: 85%; left: 46%;" onclick="showClassInfo('æœä¸‰ä¹™')">æœä¸‰ä¹™</div>
                <div class="pin red-dot" id="pin-h2" style="top: 85%; left: 59%;" onclick="showClassInfo('å®¶äºŒä¹™')">å®¶äºŒä¹™</div>
                <div class="pin red-dot" id="pin-f2" style="top: 20%; left: 69%;" onclick="showClassInfo('æœäºŒç”²')">æœäºŒç”²</div>
                
                <div class="pin me" style="top: 85%; left: 8%;" onclick="showInfo('æœå‹™å°', 'æœå‹™å° / å…¥å£è™•')">æœå‹™å°</div>
            </div>
        </div>

        <div class="map-actions">
            <button id="btn-ijen" class="btn-main" style="width: auto; background: #F59E0B;" onclick="toggleIJenShih()">ğŸ‘ï¸ æ‰¾ Içé£Ÿ</button>
            <button class="btn-main" style="width: auto; background: #8B5CF6;" onclick="initLottery()">ğŸ° å¯¶ç®±æŠ½ç</button>
        </div>
    </div>

    <div id="tab-search" class="page">
        <input type="text" class="search-bar" placeholder="ğŸ” æœå°‹æ”¤ä½ã€ç‚’éºµ..." oninput="doSearch(this.value)">
        <div id="default-search-view">
            <h4 style="margin: 15px 0 10px;">ğŸ”¥ ç†±æœ</h4>
            <div class="keyword-box">
                <span class="keyword" onclick="doSearch('çå¥¶')">çå¥¶</span>
                <span class="keyword" onclick="doSearch('é›æ’')">é›æ’</span>
                <span class="keyword" onclick="doSearch('ä¹™')">ä¹™ç­</span>
            </div>
            <h4 style="margin: 20px 0 10px;">ğŸ† æ’è¡Œæ¦œ</h4>
            <div id="ranking-list"></div>
        </div>
        <div id="search-results" style="margin-top: 15px;"></div>
    </div>

    <div id="tab-cart" class="page">
        <h3 style="margin-top: 0;">æˆ‘çš„è³¼ç‰©è»Š</h3>
        <div id="cart-content"></div>
        <div id="checkout-section" class="checkout-box" style="display:none;">
            <div style="display:flex; justify-content:space-between; font-size: 1.1rem; font-weight: bold; margin-bottom: 10px;">
                <span>ç¸½é‡‘é¡</span>
                <span id="total-price" style="color: var(--primary);">$0</span>
            </div>
            <label class="delivery-option">
                <input type="checkbox" id="delivery-check" onchange="toggleDeliveryLocation()">
                <span>ğŸ›µ éœ€è¦å¤–é€ï¼Ÿ</span>
            </label>
            <div id="location-input-div" style="display:none; margin-bottom: 15px;">
                <input type="text" id="delivery-location" class="search-bar" placeholder="è¼¸å…¥åœ°é» (ä¾‹: 201æ•™å®¤)" style="background: white; border: 1px solid var(--primary);">
            </div>
            <button class="btn-main btn-line" onclick="submitOrderWithLine()">ğŸ’¬ å‚³é€è¨‚å–®åˆ° LINE</button>
        </div>
    </div>

    <nav class="bottom-nav" id="main-nav" style="display:none;">
        <div class="nav-item active" onclick="switchTab('classes', this)"><span class="nav-icon">ğŸ </span>ç­ç´š</div>
        <div class="nav-item" onclick="switchTab('map', this)"><span class="nav-icon">ğŸ—ºï¸</span>åœ°åœ–</div>
        <div class="nav-item" onclick="switchTab('search', this)"><span class="nav-icon">ğŸ”</span>æœå°‹</div>
        <div class="nav-item" onclick="switchTab('cart', this)"><span class="nav-icon">ğŸ›’</span>é è³¼<span class="badge" id="cart-badge">0</span></div>
    </nav>

    <div class="modal-overlay" id="info-modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="m-title" style="margin-top: 5px;"></h3>
            <div id="m-desc" style="color: #666; line-height: 1.6; margin: 15px 0;"></div>
            <div id="m-action"></div>
        </div>
    </div>

</div>

<script>
    const MY_LIFF_ID ="2008950464-nvPXhIih"; 

    const products = [
        { id: 1, class: 'å•†ä¸‰ä¹™', name: 'ç‰¹èª¿çç å¥¶èŒ¶', price: 50, tag: 'hot', desc: 'æ¯æ—¥ç¾ç…®çç ï¼Œæœ¬ç­æ‹›ç‰Œï¼', sold: 120 },
        { id: 2, class: 'å•†ä¸‰ä¹™', name: 'å¤§è…¸åŒ…å°è…¸', price: 60, tag: '', desc: 'æ­£å®—å°å¼å£å‘³ï¼Œè’œé ­åŠ çˆ†ã€‚', sold: 85 },
        { id: 3, class: 'æœä¸‰ä¹™', name: 'æ‰‹å·¥é€ å‹é¤…ä¹¾', price: 30, tag: '', desc: 'ç´”æ‰‹å·¥è£½ä½œï¼Œé€ å‹å¯æ„›ã€‚', sold: 210 },
        { id: 4, class: 'å®¶äºŒä¹™', name: 'æ—¥å¼ç‚’æ³¡éºµ', price: 55, tag: 'sale', desc: 'Içé£Ÿç‰¹åƒ¹ä¸­ï¼æ–™å¤šå¯¦åœ¨ã€‚', sold: 150 },
        { id: 5, class: 'æœäºŒç”²', name: 'ä¹¾å†°æ±½æ°´', price: 40, tag: '', desc: 'å†’ç…™çš„æ±½æ°´ï¼Œæ‰“å¡å¿…å‚™ï¼', sold: 95 },
        { id: 6, class: 'å•†ä¸‰ä¹™', name: 'è„†çš®é›æ’', price: 70, tag: 'hot', desc: 'ç¾ç‚¸å¤šæ±ï¼Œå¤–é…¥å…§å«©ã€‚', sold: 300 }
    ];

    let cart = [];
    let discount = 1;
    let panzoomInstance = null; // å®£å‘Šåœ°åœ–ç¸®æ”¾å¯¦ä¾‹

    document.addEventListener("DOMContentLoaded", function() {
        // â˜… æ–°å¢ï¼šåˆå§‹åŒ– Panzoom åœ°åœ–ç¸®æ”¾ â˜…
        const mapContent = document.getElementById('map-content');
        panzoomInstance = Panzoom(mapContent, {
            maxScale: 4,        // æœ€å¤§æ”¾å¤§ 4 å€
            minScale: 1,        // æœ€å°ç¸®å°åˆ°åŸæœ¬å¤§å°
            step: 0.3,          // æ¯æ¬¡ç¸®æ”¾çš„ç´šè·
            cursor: 'grab'
        });

        // ç¶å®šï¼šæ»‘é¼ æ»¾è¼ªç¸®æ”¾
        const mapViewport = document.getElementById('map-viewport');
        mapViewport.addEventListener('wheel', panzoomInstance.zoomWithWheel);

        // ç¶å®šï¼šç¸®æ”¾æŒ‰éˆ•
        document.getElementById('btn-zoom-in').addEventListener('click', panzoomInstance.zoomIn);
        document.getElementById('btn-zoom-out').addEventListener('click', panzoomInstance.zoomOut);
        document.getElementById('btn-zoom-reset').addEventListener('click', () => {
            panzoomInstance.reset();
        });

        let liffInitTimeout = setTimeout(function() {
            const loginPage = document.getElementById('page-login');
            if (loginPage && loginPage.style.display !== 'none') {
                document.getElementById('login-msg').innerText = "é€£ç·šç¨å¾®å»¶é²ï¼Œæ‚¨å¯ä»¥ç›´æ¥é€²å…¥ ğŸ‘‡";
                document.getElementById('login-msg').style.color = "#FF4757";
                document.getElementById('manual-login').style.display = 'block';
                document.getElementById('btn-line-login').style.display = 'none'; 
            }
        }, 3000);

        liff.init({ liffId: MY_LIFF_ID })
            .then(function() {
                clearTimeout(liffInitTimeout); 
                if (liff.isLoggedIn()) {
                    return liff.getProfile();
                } else {
                    document.getElementById('login-msg').innerText = "è«‹ç™»å…¥";
                    document.getElementById('btn-line-login').style.display = 'block';
                    document.getElementById('manual-login').style.display = 'block';
                    return Promise.reject("æœªç™»å…¥"); 
                }
            })
            .then(function(profile) {
                if(profile) loginSuccess(profile.displayName, profile.pictureUrl);
            })
            .catch(function(err) {
                clearTimeout(liffInitTimeout);
                if (err !== "æœªç™»å…¥") {
                    document.getElementById('login-msg').innerText = "é–‹ç™¼æ¨¡å¼ / é€£ç·šå¤±æ•—";
                    document.getElementById('manual-login').style.display = 'block';
                }
            });
    });

    function showInfo(title, text) {
        document.getElementById('m-title').innerText = title;
        document.getElementById('m-desc').innerHTML = text.replace(/\n/g, '<br>'); 
        document.getElementById('m-action').innerHTML = '<button class="btn-main" onclick="closeModal()">çŸ¥é“äº†</button>';
        document.getElementById('info-modal').style.display = 'flex';
    }

    function showClassInfo(className) {
        const classProducts = products.filter(p => p.class === className);
        let html = `<div style="text-align:left; max-height: 50vh; overflow-y: auto; margin-top: 5px;">`;
        
        classProducts.forEach(p => {
            let isSale = p.tag === 'sale';
            let tagHtml = isSale ? `<span style="background:#FFEDD5; color:#C2410C; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; display:inline-block; font-weight:bold;">ğŸ”¥ Içé£Ÿç‰¹åƒ¹</span><br>` : '';
            
            html += `
                <div style="background: #F9FAFB; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.02);">
                    <div style="flex:1;">
                        ${tagHtml}
                        <div style="font-weight:bold; font-size: 1rem; color: #333; margin-bottom: 4px;">${p.name}</div>
                        <div style="font-size: 0.85rem; color: #666;">$${p.price}</div>
                    </div>
                    <div class="btn-add" onclick="addToCart(${p.id}); showInfo('åŠ å…¥æˆåŠŸ', 'ğŸ›’ å·²å°‡ ${p.name} åŠ å…¥è³¼ç‰©è»Šï¼')" style="margin-left: 10px; background: var(--primary); color: white;">+</div>
                </div>
            `;
        });
        
        html += `</div>`;

        document.getElementById('m-title').innerText = `ğŸ“ ${className}`;
        document.getElementById('m-desc').innerHTML = html;
        document.getElementById('m-action').innerHTML = '<button class="btn-main" style="background:#ddd; color:#333;" onclick="closeModal()">é—œé–‰è¦–çª—</button>';
        document.getElementById('info-modal').style.display = 'flex';
    }

    let isShowingIJen = false;
    function toggleIJenShih() {
        isShowingIJen = !isShowingIJen;
        const btn = document.getElementById('btn-ijen');
        const allRedDots = document.querySelectorAll('.pin.red-dot');

        if (isShowingIJen) {
            btn.innerHTML = "âŒ é—œé–‰é›·é”";
            btn.style.background = "#E11D48"; 
            const saleClasses = [...new Set(products.filter(p => p.tag === 'sale').map(p => p.class))];

            allRedDots.forEach(pin => {
                const className = pin.textContent.trim(); 
                if (saleClasses.includes(className)) {
                    pin.classList.remove('dimmed');
                    pin.classList.add('ijen-active');
                } else {
                    pin.classList.add('dimmed');
                    pin.classList.remove('ijen-active');
                }
            });
        } else {
            btn.innerHTML = "ğŸ‘ï¸ æ‰¾ Içé£Ÿ";
            btn.style.background = "#F59E0B";
            allRedDots.forEach(pin => {
                pin.classList.remove('dimmed', 'ijen-active');
            });
        }
    }

    function loginSuccess(name, avatarUrl) {
        document.getElementById('user-display').innerText = name;
        if(avatarUrl) {
            document.getElementById('user-avatar').src = avatarUrl;
            document.getElementById('user-avatar').style.display = 'block';
        }
        document.getElementById('page-login').style.display = 'none';
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('main-nav').style.display = 'flex';
        switchTab('classes', document.querySelector('.nav-item'));
        renderProducts(products);
        renderRanking();
    }

    function handleManualLogin() {
        const name = document.getElementById('login-user').value.trim();
        if (!name) return showInfo('æç¤º', 'è«‹è¼¸å…¥æš±ç¨±'); 
        loginSuccess(name, null);
    }

    function switchTab(tabId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        
        // â˜… ä¿®å¾©ï¼šåˆ‡æ›åˆ°åœ°åœ–æ™‚é‡æ–°å°é½Šä¸€æ¬¡ â˜…
        if(tabId === 'map' && panzoomInstance) {
            setTimeout(() => { panzoomInstance.reset(); }, 50);
        }
        
        if(tabId === 'cart') renderCart();
        window.scrollTo(0,0);
    }

    function renderProducts(list) {
        const container = document.getElementById('product-list');
        container.innerHTML = '';
        if(list.length === 0) return container.innerHTML = '<p style="text-align:center;color:#999;margin-top:30px;">ç„¡å•†å“</p>';
        list.forEach(p => {
            let tagHtml = p.tag === 'hot' ? '<span class="tag-sale" style="background:#FEE2E2;color:#EF4444;">ç†±éŠ·</span>' : (p.tag === 'sale' ? '<span class="tag-sale">Içé£Ÿ</span>' : '');
            container.innerHTML += `
                <div class="product-item">
                    <div class="p-info" onclick="showProductDetailWithId(${p.id})">
                        <div class="p-name">${p.name}</div>
                        <div class="p-meta">${tagHtml} <span>${p.class}</span> <span style="font-weight:bold;">$${p.price}</span></div>
                    </div>
                    <div class="btn-add" onclick="addToCart(${p.id})">+</div>
                </div>`;
        });
    }

    function filterProducts(cls, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderProducts(cls === 'all' ? products : products.filter(p => p.class === cls));
    }

    function showProductDetailWithId(id) {
        const p = products.find(i => i.id === id);
        document.getElementById('m-title').innerText = p.name;
        document.getElementById('m-desc').innerHTML = `ç­ç´šï¼š${p.class}<br>åƒ¹æ ¼ï¼š<span style="color:var(--primary);font-weight:bold;">$${p.price}</span><br><br>${p.desc}`;
        document.getElementById('m-action').innerHTML = `<button class="btn-main" onclick="addToCart(${p.id}); closeModal()">åŠ å…¥è³¼ç‰©è»Š</button>`;
        document.getElementById('info-modal').style.display = 'flex';
    }

    let hasPlayed = false;
    function initLottery() {
        if(hasPlayed) return showInfo("æç¤º", "å·²ç¶“æŠ½éå›‰ï¼"); 
        document.getElementById('m-title').innerText = "å¯¶ç®±ä¸‰é¸ä¸€";
        document.getElementById('m-desc').innerHTML = "é¸ä¸€å€‹å¯¶ç®±ï¼Œæœ‰æ©Ÿæœƒç²å¾— <b>9æŠ˜</b> å„ªæƒ ï¼";
        document.getElementById('m-action').innerHTML = `
            <div class="chest-container">
                <div class="chest" id="chest-0" onclick="playChest(0)">ğŸ</div>
                <div class="chest" id="chest-1" onclick="playChest(1)">ğŸ</div>
                <div class="chest" id="chest-2" onclick="playChest(2)">ğŸ</div>
            </div>
            <div id="lottery-result" style="height:30px; font-weight:bold; color:var(--danger);"></div>`;
        document.getElementById('info-modal').style.display = 'flex';
    }

    function playChest(index) {
        if(hasPlayed) return;
        hasPlayed = true;
        const isWin = Math.random() > 0.4; 
        for(let i=0; i<3; i++) {
            const el = document.getElementById(`chest-${i}`);
            if(i === index) el.innerHTML = isWin ? "ğŸ‰<div class='chest-label'>9æŠ˜</div>" : "ğŸ’¨<div class='chest-label'>æ²’ä¸­</div>";
            else el.classList.add('disabled');
        }
        const resDiv = document.getElementById('lottery-result');
        if(isWin) { discount = 0.9; resDiv.innerText = "æ­å–œä¸­çï¼çµå¸³è‡ªå‹•æ‰“ 9 æŠ˜ï¼"; } 
        else { resDiv.innerText = "å¯æƒœæ²’ä¸­..."; resDiv.style.color = "#666"; }
    }

    function addToCart(id) { cart.push(products.find(p => p.id === id)); updateBadge(); }
    function updateBadge() { const b = document.getElementById('cart-badge'); b.innerText = cart.length; b.style.display = cart.length>0?'block':'none'; }
    
    function renderCart() {
        const c = document.getElementById('cart-content'), s = document.getElementById('checkout-section');
        if(cart.length===0) { c.innerHTML='<div style="text-align:center;color:#999;margin-top:20px;">ç©ºç©ºå¦‚ä¹Ÿ</div>'; s.style.display='none'; return; }
        c.innerHTML=''; let total=0;
        cart.forEach((p,i)=>{ total+=p.price; c.innerHTML+=`<div class="product-item"><div class="p-info"><div class="p-name">${p.name}</div><div class="p-meta">$${p.price}</div></div><div style="color:red;font-weight:bold;cursor:pointer;" onclick="cart.splice(${i},1);renderCart();updateBadge()">âœ•</div></div>`; });
        let finalPrice = Math.floor(total * discount);
        document.getElementById('total-price').innerText = `$${finalPrice}` + (discount < 1 ? " (å·²æŠ˜åƒ¹)" : "");
        s.style.display='block';
    }

    function toggleDeliveryLocation() {
        document.getElementById('location-input-div').style.display = document.getElementById('delivery-check').checked ? 'block' : 'none';
    }

    function submitOrderWithLine() {
        const isDelivery = document.getElementById('delivery-check').checked;
        const location = document.getElementById('delivery-location').value;
        if(isDelivery && !location) return showInfo("æç¤º", "è«‹è¼¸å…¥å¤–é€åœ°é»"); 

        const finalPrice = document.getElementById('total-price').innerText;
        const userName = document.getElementById('user-display').innerText;
        
        let msg = `ğŸ“‹ [æ–°è¨‚å–®]\nè¨‚è³¼äººï¼š${userName}\n------------------\n`;
        cart.forEach(p => { msg += `â–«ï¸ ${p.name} ($${p.price})\n`; });
        msg += `------------------\nğŸ’° ç¸½é¡ï¼š${finalPrice}\nğŸ“ ${isDelivery ? 'å¤–é€è‡³ï¼š'+location : 'è‡ªå–'}`;

        if (liff.isInClient()) {
            liff.sendMessages([{ type: 'text', text: msg }])
                .then(() => { showInfo("æˆåŠŸ", "å·²å‚³é€åˆ°èŠå¤©å®¤ï¼"); resetCart(); }) 
                .catch((err) => { console.error(err); showInfo("éŒ¯èª¤", "å‚³é€å¤±æ•—"); }); 
        } else {
            showInfo("è¨‚å–®å·²å»ºç«‹ï¼", msg); 
            resetCart();
        }
    }

    function resetCart() {
        cart = []; updateBadge(); 
        document.getElementById('delivery-check').checked = false;
        document.getElementById('location-input-div').style.display = 'none';
        switchTab('classes', document.querySelector('.nav-item'));
    }

    function doSearch(val) { 
        const resultBox = document.getElementById('search-results');
        const defaultView = document.getElementById('default-search-view');
        if(!val) { resultBox.innerHTML = ''; defaultView.style.display = 'block'; return; }
        defaultView.style.display = 'none';
        const matches = products.filter(p => p.name.includes(val) || p.class.includes(val));
        resultBox.innerHTML = '';
        if(matches.length === 0) return resultBox.innerHTML = '<p style="text-align:center;color:#999">ç„¡çµæœ</p>';
        matches.forEach(p => {
            resultBox.innerHTML += `<div class="product-item"><div class="p-info" onclick="showProductDetailWithId(${p.id})"><div class="p-name">${p.name}</div><div class="p-meta">${p.class} / $${p.price}</div></div><div class="btn-add" onclick="addToCart(${p.id})">+</div></div>`;
        });
    }

    function renderRanking() { 
        const list = document.getElementById('ranking-list');
        const sorted = [...products].sort((a,b) => b.sold - a.sold).slice(0, 3);
        list.innerHTML = '';
        sorted.forEach((p, i) => list.innerHTML += `<div class="product-item" style="border-left:3px solid var(--primary);"><div class="p-info" onclick="showProductDetailWithId(${p.id})"><div class="p-name">No.${i+1} ${p.name}</div><div class="p-meta">å”®å‡º ${p.sold}</div></div><div class="btn-add" onclick="addToCart(${p.id})">+</div></div>`);
    }

    function closeModal() { document.getElementById('info-modal').style.display = 'none'; }
</script>
</body>
</html>


